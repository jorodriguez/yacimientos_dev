<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:my="http://www.mytags.com/schema/mytags"
      xmlns:p="http://primefaces.org/ui"      
      >
    <body>
        <ui:composition template="./../../WEB-INF/template/template.xhtml">
            <ui:define name="content">

                <!--<icecore:config render="true"/>-->

                <h:panelGroup rendered="#{empty sesion.usuario}">
                    <ui:include src="../../salir.xhtml"/>
                </h:panelGroup>
                <h:form id="frmTickets"  styleClass="textoIzquierda" rendered="#{not empty sesion.usuario}" >                    
                    <div class="page-header">
                        <h3>Tickets</h3>
                    </div>

                    <div class="jumbotron">
                        <div class="form-row">
                            <div class="form-row">
                                <p:commandButton actionListener="#{incidenciaBean.crearIncidecnia(e)}" 
                                                 icon="pi pi-plus"
                                                 styleClass="ui-button"
                                                 value="Registrar nuevo ticket"
                                                 title="Registrar nuevo ticket" 

                                                 >                                    
                                </p:commandButton>
                                <p:commandButton actionListener="#{incidenciaBean.refrescarTickets(e)}" 
                                                 styleClass="ui-button ui-button-secondary"
                                                 icon="fa fa-refresh"
                                                 title="Refrescar tickets" immediate="true">                                    
                                </p:commandButton>
                            </div>
                            <div class="form-row">
                                <!--<ace:dataTable value="{incidenciaBean.incidencias}" var="dataInc">-->
                                <p:dataTable 
                                    id="tickets"
                                    showGridlines="true"                                     
                                    rows="10"        
                                    stripedRows="true"
                                    value="#{incidenciaBean.incidencias}" 
                                    var="dataInc"
                                    >
                                  
                                    <p:column headerText="Código" style="width:10%;text-align: center" sortBy="#{dataInc.codigo}" >
                                        <h:outputLabel value="#{dataInc.codigo}"/><br/>
                                        <h:outputText value="#{dataInc.categoriaIncidencia}"/>
                                    </p:column>                                   
                                    
                                    <p:column headerText="Ticket" styleClass="text-left" style="width:65%;text-align: left; ">
                                        <h:outputLabel value="#{dataInc.titulo}"/><br/>
                                        <h:outputText value="#{dataInc.descripcion}"/><br/><br/>
                                        <i class="fa fa-calendar-o"/>
                                        <h:outputText value="#{dataInc.fechaGenero}"/>  
                                        <i class="fa fa-clock-o"/>
                                        <h:outputText value=" #{dataInc.horaGenero}"/>
                                    </p:column>                                    
                                    
                                    <p:column headerText="Estado"  styleClass="text-center">
                                        <h:outputText value="#{dataInc.estado}"/>
                                    </p:column>
                                    <p:column style="text-align: center">
                                        <p:commandButton actionListener="#{incidenciaBean.agregarAdjunto(e)}"
                                                       styleClass="rounded-button ui-button-flat"                                                        
                                                       icon="fa fa-paperclip"
                                                       title="Agregar archivo">                                            
                                            <f:param name="idTicket" value="#{dataInc.idIncidencia}"/>
                                        </p:commandButton>					
                                    
                                        <p:commandButton actionListener="#{incidenciaBean.inicioReenviarTicket(e)}"
                                                       styleClass="rounded-button ui-button-flat " 
                                                       icon="fa fa-edit fa-2x"
                                                       title="Agregar complemento">                                            
                                            <f:param name="idTicket" value="#{dataInc.idIncidencia}"/>
                                        </p:commandButton>					
                                    
                                        <p:commandButton actionListener="#{incidenciaBean.inicioCerrarTicket(e)}"
                                                       styleClass="rounded-button ui-button-flat text-danger" 
                                                       rendered="#{dataInc.idEstado eq 1210}"
                                                       icon="pi pi-times"
                                                       style="color: red;"
                                                       title="Finalizar el ticket">                                            
                                            <f:param name="idTicket" value="#{dataInc.idIncidencia}"/>
                                        </p:commandButton>					
                                    </p:column>
                                    
                                </p:dataTable>
                                <p:blockUI block="tickets" trigger="tickets" widgetVar="buiDatatable">
                                    <i class="pi pi-spin pi-spinner" style="font-size: 3rem"></i>
                                </p:blockUI>
                            </div>
                        </div>   
                    </div>
                </h:form>

                <div class="modal fade" id="dialogoAdjuntaarTickt" data-backdrop="static" data-keyboard="false">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title">Agregar archivo a Tickets</h4>
                            </div>
                            <h:form id="frmAdjTick">
                                <div class="modal-body">

                                    <!--<ace:fileEntry id="adjArch"
                                                   styleClass="btn btn-default"
                                                   label="Archivo"
                                                   absolutePath="/tmp"
                                                   useSessionSubdir="true"
                                                   fileEntryListener="{incidenciaBean.subirAdjunto}"
                                                   useOriginalFilename="true"
                                                   immediate="false" />
                                    -->

                                    <!-- Probar -->
                                    <h:form id="formUpload" enctype="multipart/form-data">
                                        <p:fileUpload id="fileEntryAdjunto" 
                                                      multiple="false"
                                                      label="Seleccionar"                                                                                  
                                                      uploadLabel="Subir"                                                                                  
                                                      uploadButtonTitle="Subir"
                                                      uploadButtonStyleClass="ui-button-success  "                                                                                  
                                                      cancelLabel="Cancelar"
                                                      cancelButtonTitle="Cancelar"                
                                                      cancelButtonStyleClass="ui-button-secondary"
                                                      mode="advanced"                                                                                  
                                                      fileLimit="1"
                                                      fileLimitMessage="Solo puede subir 1 archivo"
                                                      previewWidth="100"
                                                      oncomplete="$('#dialogoAdjuntaarTickt').modal('hide')"
                                                      update="@form frmTickets"
                                                      listener="#{incidenciaBean.subirAdjunto}"/>
                                    </h:form>

                                        <!--<p:commandButton value="Submit" ajax="false" action="#{incidenciaBean.subirAdjunto}" 
                                                         styleClass="mt-3 ui-button-outlined block"/>
                                    -->


                                    <h:commandButton  styleClass="btn btn-default" id="uploadFile" value="Subir y Enviar"/>
                                    <div class="form-row">
                                        <!--
                                        <ace:dataTable id="dtArchivo" value="{incidenciaBean.incidenciasAdjunto}" var="dataAdj"
                                                       rowIndexVar="index">
                                        -->
                                        <p:dataTable id="dtArchivo" 
                                                     showGridlines="true" 
                                                     size="small" 
                                                     rows="10"  
                                                     value="#{incidenciaBean.incidenciasAdjunto}" 
                                                     var="dataAdj"
                                                     rowIndexVar="index"
                                                     paginator="true" paginatorPosition="both"
                                                     >
                                            <p:column >
                                                <p:headerRow>Evidencia</p:headerRow>
                                                <h:outputLink target="_blank"  
                                                              value="/Sia/AbrirArchivo?ZWZ2W=#{dataAdj.id}&amp;ZWZ3W=#{dataAdj.uuid}">
                                                    <h:outputText value="#{dataAdj.nombre}"/>
                                                </h:outputLink>
                                            </p:column>
                                            <p:column >
                                                <h:commandLink actionListener="#{incidenciaBean.eliminarArchivo(dataAdj.idTabla)}"
                                                               
                                                               immediate="true" rendered="#{incidenciaBean.incidenciaVo.idEstado eq 1210}">
                                                    <i class="fa fa-trash text-danger"/>
                                                    <f:ajax execute="@this" render="@form"/>
                                                </h:commandLink> 
                                            </p:column>
                                        </p:dataTable>    
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <h:commandButton value="Cerrar" styleClass="btn btn-default"
                                                     onclick="$(dialogoAdjuntaarTickt).modal('hide');"/>
                                </div>
                            </h:form>
                        </div>
                    </div>
                </div>


                <div class="modal fade" id="dialogoNuevoTickts" data-backdrop="static" data-keyboard="false">
                    <div class="modal-dialog ">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title">Registro de incidencias (Tickets)</h4>
                            </div>
                            <h:form id="frmNuevoTick">
                                <div class="modal-body">
                                    <div class="form-group">
                                        <h:outputText class="control-label" value="Categoría:"/>
                                        <div >
                                            <h:selectOneMenu value="#{incidenciaBean.idCatIncidencia}"
                                                             styleClass="form-control">
                                                <f:selectItems value="#{incidenciaBean.tiposEvidencias}" />
                                                <f:ajax listener="#{incidenciaBean.traerCategoria}" execute="@this" event="change"
                                                        render="txtCodCat codSeleccionado"/>
                                            </h:selectOneMenu>
                                        </div>
                                    </div>
                                    <div  id="divCodigo"> 
                                        <div  class="form-group">
                                            <div class="form-inline">
                                                <h:outputText id="txtCodCat" class="control-label" value="¿Tiene un código de #{incidenciaBean.categoriaIncidenciaVo.nombre} ?"/>
                                            </div>
                                            <div class="form-inline">
                                                <h:selectOneRadio id="codSeleccionado" value="#{incidenciaBean.idTieneCod}"
                                                                  styleClass="form-control">
                                                    <f:selectItem itemLabel="Si" itemValue="1"/>
                                                    <f:selectItem itemLabel="No" itemValue="0"/>
                                                    <f:ajax render="txtCodigo" execute="@this" event="change"
                                                            listener="#{incidenciaBean.mostrarTextoCodigo}"/>
                                                </h:selectOneRadio>
                                            </div>
                                            <div id="inpCod" class="form-inline">
                                                <h:inputText id="txtCodigo" styleClass="form-control" value="#{incidenciaBean.incidenciaVo.codigoCategoria}"/>
                                                <h:messages id="msgCod" errorClass="text-danger small"/>
                                            </div>
                                            <div id="noInpCod" class="form-inline">
                                                <h:outputText value="No aplica" style="font-weight: bold;"/>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <h:outputText class="control-label" value="Título:*"/>
                                        <div >
                                            <h:inputText id="txtTitulo" styleClass="form-control" value="#{incidenciaBean.incidenciaVo.titulo}"
                                                         required="true" requiredMessage="Agregue un título"/>
                                            <h:message for="txtTitulo" errorClass="text-danger"/>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <h:outputText class="control-label" value="Descripción:*"/>
                                        <div >
                                            <h:inputTextarea id="txtDes" styleClass="form-control" value="#{incidenciaBean.incidenciaVo.descripcion}"
                                                             required="true" requiredMessage="Agregue un descripción"/>
                                            <h:message for="txtDes" errorClass="text-danger"/>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <h:outputText class="control-label" value="Prioridad"/>
                                        <div >
                                            <h:selectOneMenu value="#{incidenciaBean.idPrioridad}"
                                                             styleClass="form-control">
                                                <f:selectItems value="#{incidenciaBean.prioridades}" />
                                            </h:selectOneMenu>
                                        </div>
                                    </div>
                                </div> 
                                <div class="modal-footer">
                                    <h:commandButton value="Cancelar" immediate="true"
                                                     styleClass="btn btn-default"
                                                     onclick="$(dialogoNuevoTickts).modal('hide');"
                                                     title="Cerrar ventana de crear tickets...">
                                    </h:commandButton>
                                    <h:commandButton value="Guardar y enviar"
                                                     styleClass="btn btn-primary"
                                                     actionListener="#{incidenciaBean.guardarEnviarIncidencia(e)}"
                                                     title="Guardar y solicitar tickets..."/>
                                </div>
                            </h:form>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="dialogoComplementoTickt" data-backdrop="static" data-keyboard="false">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title">Complemento de Tickets</h4>
                            </div>
                            <h:form id="frmCompTick">
                                <div class="modal-body">
                                    <div class="form-row">
                                        <h:outputLabel value="Complemento:*"/>
                                        <h:inputTextarea id="txtArea" value="#{incidenciaBean.complemento}" required="true" requiredMessage="Agregue un complemento"
                                                         rows="5" styleClass="form-control"/>
                                        <h:message for="txtArea" errorClass="text-danger"/>
                                    </div>                                    
                                </div>
                                <div class="modal-footer">
                                    <h:commandLink value="Cancelar" immediate="true"
                                                   styleClass="btn btn-default"
                                                   onclick="$(dialogoComplementoTickt).modal('hide');"
                                                   title="Cerrar ventana de complemento de tickets..."/>
                                    <h:commandLink value="Guardar y enviar"
                                                   styleClass="btn btn-primary"
                                                   actionListener="#{incidenciaBean.reenviarTicket(e)}"
                                                   title="Complemento de tickets..."/>
                                </div>
                            </h:form>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="dialogoCierreTickt" data-backdrop="static" data-keyboard="false">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title">Cierre de Tickets</h4>
                            </div>
                            <h:form id="frmCierreTick">
                                <div class="modal-body">
                                    <div class="form-row">
                                        <h:outputLabel value="Motivo:*" for="txtArea"/>
                                        <p:inputTextarea id="txtArea" value="#{incidenciaBean.complemento}" required="true" 
                                                         requiredMessage="Para cerrar un ticket es necesario escribir un motivo."
                                                         rows="5" styleClass="form-control"/>
                                        <p:message for="txtArea" />
                                    </div>                                    
                                </div>
                                <div class="modal-footer">
                                    <h:commandLink value="Cancelar" immediate="true"
                                                   styleClass="btn btn-default"
                                                   onclick="$(dialogoCierreTickt).modal('hide');"
                                                   title="Cerrar ventana de cierre de tickets..."/>
                                    
                                    <p:commandLink value="Guardar y enviar"
                                                   styleClass="btn btn-primary"
                                                   update="@form"
                                                   actionListener="#{incidenciaBean.cerrarTicket(e)}"
                                                   title="Cierre de tickets..."/>
                                </div>
                            </h:form>
                        </div>
                    </div>
                </div>
            </ui:define>
        </ui:composition>

    </body>
</html>
