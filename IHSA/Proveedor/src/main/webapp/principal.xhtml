<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"      
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://java.sun.com/jsf/core">
    <body>
        <ui:composition template="./WEB-INF/template/plantilla.xhtml">            
            <ui:define name="title">   
                <ui:fragment rendered="#{!proveedorBean.bloquearFacturas}">
                    <h4 style="color: cornflowerblue;text-align: center;">#{msgs['sia.ordenes.asignadas']}</h4>
                </ui:fragment>
                <ui:fragment rendered="#{proveedorBean.bloquearFacturas}">
                    <h2 style="color: red;text-align: center;">**#{proveedorBean.bloquearFacturasMsg}**</h2>                
                </ui:fragment>
            </ui:define>
            <ui:define name="contenido">

                <!-- ui:include src="vistas/fragmento/popAgregarSoportes.xhtml"/ -->
                <ui:include src="vistas/fragmento/popMensaje.xhtml"/>
                <ui:include src="vistas/fragmento/popFacturasOrden.xhtml"/>
                <ui:include src="vistas/fragmento/datosFactura.xhtml"/>

                <script type="text/javascript">
                    $(document).ready(function () {
                        document.onkeydown = function ()
                        {
                            switch (event.keyCode)
                            {
                                case 116 : //F5 button
                                    event.returnValue = false;
                                    event.keyCode = 0;
                                    return false;
                                case 82 : //R button
                                    if (event.ctrlKey)
                                    {
                                        event.returnValue = false;
                                        event.keyCode = 0;
                                        return false;
                                    }
                            }
                        }
                    });
                </script>
                <div class="row">
                    <h:form id="frmPrincipal">
                        <p:tabView id="tbPrincipal" >
                            <p:tab id="tabOrdenes" title="#{msgs['sia.orden.asignadas']} ( #{proveedorBean.mapaTotales.get('totalOCS')} )" 
                                   rendered="#{!proveedorBean.bloquearFacturas and !(proveedorBean.mapaInicial.size() eq 0)}">
                                <div class="row" 
                                     data-hint='Seleccione una de las órdenes pulsando en el engrane azul en la última columna de cada renglón.'>                                    
                                    <div class="col-5">                                        
                                        <div class="col-3">
                                            <h4>#{msgs['presupuesto.nuevos.campoCompania']}: </h4>
                                        </div>
                                        <div class="col-9">
                                            <h:selectOneMenu id="companias" value="#{sesion.rfcCompania}" 
                                                             class="form-control" >
                                                <f:selectItems value="#{sesion.empresas}"/>
                                                <p:ajax  listener="#{proveedorBean.seleccionarEmpresa}"
                                                         update="frmMensajePrincipal" process="@this"/>
                                            </h:selectOneMenu>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="col-3">
                                            <h4>#{msgs['sia.bloque.nombre']}: </h4>
                                        </div>
                                        <div class="col-8">
                                            <h:selectOneMenu id="campos"
                                                             value="#{proveedorBean.campo}" 
                                                             class="form-control" >
                                                <p:ajax process="@this" update="frmPrincipal:tbPrincipal" 
                                                        listener="#{proveedorBean.seleccionarCliente}"/>
                                                <f:selectItems value="#{proveedorBean.selectCampo.get('asignada')}"/>
                                            </h:selectOneMenu>
                                        </div>
                                    </div>
                                    <div class="col-3 input-group">
                                        <p:inputText id="codOcs" class="form-control" value="#{proveedorBean.codigoOrden}"
                                                     placeholder="Códido de orden"/>
                                        <div>
                                            <p:commandLink id="buscarOrden" action="#{proveedorBean.buscarOrden()}" class="btn btn-info text-white" 
                                                           process="@this frmPrincipal:tbPrincipal:codOcs" update="frmPrincipal:tbPrincipal">
                                                <i class="fa fa-search"/>
                                            </p:commandLink>
                                        </div>
                                    </div>
                                </div>
                                <div class="table table-responsive" id="tablaOrdenes">
                                    <p:dataTable value="#{proveedorBean.mapaInicial.get('ordenCompra')}" var="data" paginator="true" 
                                                 rows="10" paginatorPosition="bottom" size="small" showGridlines="true">
                                        <p:column headerText="#{msgs['sia.orden']}" style="#{data.fcreada ? 'color: blue' : ''}">
                                            #{data.consecutivo}
                                        </p:column>
                                        <p:column headerText="#{msgs['sia.orden.pedido']}" style="#{data.fcreada ? 'color: blue' : ''}">
                                            #{data.navCode}
                                        </p:column>
                                        <p:column headerText="#{msgs['sia.bloque.nombre']}" style="#{data.fcreada ? 'color: blue' : ''}">
                                            #{data.bloque}
                                        </p:column>
                                        <p:column headerText="#{msgs['sia.nombre.referencia']}"  style="#{data.fcreada ? 'color: blue;text-align: left;' : 'text-align: left;'}">
                                            #{data.referencia}
                                        </p:column>
                                        <p:column headerText="#{msgs['sia.contrato']}" style="#{data.fcreada ? 'color: blue' : ''}">
                                            <h:outputText value="#{data.contratoVO.codigo eq 'OCS_SIN_CONTRATO' ? 'Sin contrato' : data.contratoVO.codigo}"/>                                            
                                        </p:column>
                                        <p:column headerText="#{msgs['sia.orden.total']}" style="#{data.fcreada ? 'color: blue;text-align: right;' : 'text-align: right;'}">                                
                                            <h:outputText value="#{data.total}">
                                                <f:convertNumber pattern="#,###.0000" />
                                            </h:outputText>
                                        </p:column>
                                        <p:column style="#{data.fcreada ? 'color: blue' : ''}"  width="5%">  
                                            #{data.monedaSiglas}
                                        </p:column>
                                        <p:column style="#{data.fcreada ? 'color: red' : ''}" width="2%">                            
                                            <p:commandLink                                                 
                                                title="#{msgs['sistema.seleccionar']}"                                                 
                                                action="#{proveedorBean.seleccionar(data.id)}">
                                                <i class="fa fa-cog fa-2x text text-primary"/>
                                            </p:commandLink>
                                        </p:column>
                                    </p:dataTable>
                                </div>
                                <div class="col-12">
                                    <h4 style="color: blue;">#{msgs['sia.factura.mensaje.pendiente']} </h4>
                                </div>
                            </p:tab>
                            <p:tab id="tabEnviadas" title="#{msgs['sia.factura.enviadas']}( #{proveedorBean.mapaTotales.get('totalFacint')} ) " 
                                   rendered="#{!proveedorBean.bloquearFacturas and !(proveedorBean.mapaInicial.size() eq 0)}">
                                <div class="row">
                                    <div class="input-group col-6">
                                        <div class="col-2">
                                            <h4>Bloque: </h4>
                                        </div>
                                        <div class="col-10">
                                            <h:selectOneMenu value="#{proveedorBean.campoEnv}" 
                                                             class="form-control" >
                                                <p:ajax process="@this" update="frmPrincipal:tbPrincipal:tabEnviadas"
                                                        listener="#{proveedorBean.seleccionarCampoFacEnviada}"/>
                                                <f:selectItems value="#{proveedorBean.selectCampo.get('enviadas')}"/>
                                            </h:selectOneMenu>
                                        </div>
                                    </div>
                                </div>
                                <div class="table table-responsive">
                                    <p:dataTable id="dtEnviadas" value="#{proveedorBean.mapaInicial.get('facturaCliente')}"  size="small" showGridlines="true"
                                                 var="dataFacEnv" rows="15" paginatorAlwaysVisible="true" 
                                                 paginatorPosition="bottom" paginator="true">
                                        <p:column headerText="#{msgs['sia.orden']}">
                                            <h:outputText value="#{dataFacEnv.codigoOrden}"/>
                                        </p:column>
                                        <p:column headerText="#{msgs['sia.bloque.nombre']}">
                                            <h:outputText value="#{dataFacEnv.campo}"/>
                                        </p:column>
                                        <p:column headerText="#{msgs['sia.nombre.referencia']}">
                                            <h:outputText value="#{dataFacEnv.concepto}"/>
                                        </p:column>
                                        <p:column headerText="#{msgs['sia.factura.folio']}">
                                            <h:outputText value="#{dataFacEnv.folio}"/>
                                        </p:column>
                                        <p:column headerText="#{msgs['sia.factura.fecha.emision']}">
                                            <h:outputText value="#{dataFacEnv.fechaEmision}"/>
                                        </p:column>
                                        <p:column headerText="#{msgs['sia.orden.total']}" style="text-align: right;">
                                            <h:outputText value="#{dataFacEnv.monto}">
                                                <f:convertNumber pattern="#,###.0000"/>
                                            </h:outputText>
                                        </p:column>
                                        <p:column headerText="#{msgs['sia.orden.moneda']}">
                                            <h:outputText value="#{dataFacEnv.moneda}"/>
                                        </p:column>
                                        <p:column width="2%">
                                            <p:commandLink value="#{msgs['sia.factura.soportes']}" class="text-primary btn btn-link "
                                                           action="#{proveedorBean.agregarSoporte(dataFacEnv.id)}"
                                                           rendered="#{dataFacEnv.idStatus eq 730 and sesion.proveedorVo.nacional eq true}"/>
                                        </p:column>
                                    </p:dataTable>
                                </div>
                            </p:tab>
                            <p:tab id="tabDevueltas" title="#{msgs['sia.factura.devueltas']}( #{proveedorBean.mapaTotales.get('totalFacturaRechazada')} )" 
                                   rendered="#{!proveedorBean.bloquearFacturas and !(proveedorBean.mapaInicial.size() eq 0)}">
                                <div class="row">
                                    <div class="input-group col-6">
                                        <div class="col-2">
                                            <h4>#{msgs['sia.bloque.nombre']}:</h4>
                                        </div>
                                        <div class="col-10">
                                            <h:selectOneMenu value="#{proveedorBean.campoRec}" 
                                                             class="form-control">
                                                <f:selectItems value="#{proveedorBean.selectCampo.get('rechazada')}"/>
                                                <p:ajax process="@this" update="frmPrincipal:tbPrincipal"
                                                        listener="#{proveedorBean.seleccionarCampoFacRechazada}"/>
                                            </h:selectOneMenu>
                                        </div>
                                    </div>
                                </div>
                                <div class="table table-responsive">
                                    <div class="table table-responsive">
                                        <p:dataTable value="#{proveedorBean.mapaInicial.get('facturaRechazada')}" var="dataFacRec" paginator="true" 
                                                     rows="10" paginatorPosition="bottom"  size="small" showGridlines="true">
                                            <p:column headerText="#{msgs['sia.orden']}">
                                                <h:outputText value="#{dataFacRec.codigoOrden}"/>
                                            </p:column>
                                            <p:column headerText="#{msgs['sia.bloque.nombre']}">
                                                <h:outputText value="#{dataFacRec.campo}"/>
                                            </p:column>
                                            <p:column headerText="#{msgs['sia.nombre.referencia']}">
                                                <h:outputText value="#{dataFacRec.concepto}"/>
                                            </p:column>
                                            <p:column headerText="#{msgs['sia.factura.folio']}">
                                                <h:outputText value="#{dataFacRec.folio}"/>
                                            </p:column>
                                            <p:column headerText="#{msgs['sia.factura.fecha.emision']}">
                                                <h:outputText value="#{dataFacRec.fechaEmision}">
                                                    <f:convertDateTime pattern="dd/MM/yyyy"/>
                                                </h:outputText>
                                            </p:column>
                                            <p:column headerText="#{msgs['sia.orden.total']}" style=" text-align: right">
                                                <h:outputText value="#{dataFacRec.monto}"> 
                                                    <f:convertNumber pattern="#,###.0000"/>
                                                </h:outputText>
                                            </p:column>
                                            <p:column headerText="#{msgs['sia.orden.moneda']}">
                                                <h:outputText value="#{dataFacRec.moneda}"/>
                                            </p:column>
                                            <p:column width="2%">
                                                <p:commandLink  title="#{msgs['sia.factura.seleccionar.devuelta']}" 
                                                                action="#{proveedorBean.seleccionarFactura(dataFacRec.id)}"
                                                                >
                                                    <i class="fa fa-cog fa-2x text text-primary"/>
                                                </p:commandLink>
                                            </p:column>
                                        </p:dataTable>
                                    </div>
                                </div>
                            </p:tab>
                            <p:tab id="tabComplentoPago" title="#{msgs['sia.factura.complemento.pago']} ( #{proveedorBean.mapaTotales.get('totalCXP')} )" >
                                <div class="row">
                                    <div class="input-group col-6">
                                        <div class="col-2">
                                            <h4>#{msgs['sia.bloque.nombre']}:</h4>
                                        </div>
                                        <div class="col-10">
                                            <h:selectOneMenu value="#{proveedorBean.campoRecCXP}" 
                                                             class="form-control">
                                                <f:selectItems value="#{proveedorBean.selectCampo.get('facturaCXPCombo')}"/>
                                                <p:ajax process="@this" update="frmPrincipal:tbPrincipal"
                                                        listener="#{proveedorBean.seleccionarCampoCXP}"/>
                                            </h:selectOneMenu>
                                        </div>
                                    </div>
                                </div>
                                <p:dataTable id="histFacturaCXP" value="#{proveedorBean.mapaInicial.get('facturaCXP')}" var="dataFacProc"
                                             paginator="true" rows="20" paginatorPosition="bottom"  size="small" showGridlines="true">
                                    <p:column headerText="#{msgs['sia.orden']}">
                                        <h:outputText value="#{dataFacProc.codigoOrden}"/>
                                    </p:column>
                                    <p:column headerText="#{msgs['sia.orden.pedido']}">
                                        <h:outputText value="#{dataFacProc.pedidoNav}"/>
                                    </p:column>
                                    <p:column headerText="#{msgs['sia.bloque.nombre']}">
                                        <h:outputText value="#{dataFacProc.campo}"/>
                                    </p:column>
                                    <p:column headerText="#{msgs['sia.nombre.referencia']}">
                                        <h:outputText value="#{dataFacProc.concepto}"/>
                                    </p:column>
                                    <p:column headerText="#{msgs['sia.factura.folio']}">
                                        <h:outputText value="#{dataFacProc.folio}"/>
                                    </p:column>
                                    <p:column headerText="#{msgs['sia.factura.fecha.emision']}">
                                        <h:outputText value="#{dataFacProc.fechaEmision}"/>
                                    </p:column>
                                    <p:column headerText="#{msgs['sia.orden.total']}">
                                        <h:outputText value="#{dataFacProc.monto}">
                                            <f:convertNumber maxFractionDigits="2"/>
                                        </h:outputText>
                                    </p:column>
                                    <p:column headerText="#{msgs['sia.orden.moneda']}" width="5%">
                                        <h:outputText value="#{dataFacProc.moneda}"/>
                                    </p:column>

                                    <p:column width="5%">                                                
                                        <p:commandLink class="btn btn-info text-white" 
                                                       rendered="#{dataFacProc.complementoPago eq 0}"
                                                       action="#{proveedorBean.seleccionarFacturaCXPXml(dataFacProc.id)}"
                                                       title="#{msgs['sia.factura.cargar.xml']}"
                                                       process="@this" update="frmArchivoFact">
                                            <i class="fa fa-file-code-o"/> <b>CXP XML</b>
                                        </p:commandLink> 

                                        <p:commandLink action="#{proveedorBean.seleccionarFacturaCXPPdf(dataFacProc.id)}"
                                                       rendered="#{dataFacProc.complementoPago gt 0}"
                                                       title="#{msgs['sia.factura.archivo.xml.cargado']}"
                                                       process="@this" update="frmArchivoFact">
                                            <i class="fa fa-file"/> <b>XML Cargado</b>
                                        </p:commandLink>      

                                        <p:commandLink class="btn btn-info" 
                                                       style="float: right;"
                                                       action="#{proveedorBean.borrarFacturaCXPXml(dataFacProc.id)}"  
                                                       rendered="#{dataFacProc.complementoPago gt 0}"
                                                       title="#{msgs['sia.factura.complemento.pago.xml']}"
                                                       process="@this" update="frmPrincipal:tbPrincipal:tabComplentoPago">
                                            <i class="fa fa-trash"/> <b> </b>
                                        </p:commandLink>      
                                    </p:column>

                                    <p:column width="4%">                                              

                                        <p:commandLink class="#{dataFacProc.complementoPago eq 0 and dataFacProc.complementoPagoPdf eq 0 ? '' : 'btn btn-info'}" 
                                                       action="#{proveedorBean.seleccionarFacturaCXPPdf(dataFacProc.id)}"
                                                       disabled="#{dataFacProc.complementoPago eq 0 and dataFacProc.complementoPagoPdf eq 0}"
                                                       title="#{msgs['sia.factura.complemento.pdf']}"
                                                       process="@this" update="frmArchivoFact">
                                            <i class="fa fa-file-pdf-o"/> <b>CXP PDF</b>
                                        </p:commandLink>      

                                    </p:column>
                                    <p:column width="2%">
                                        <p:commandLink action="#{proveedorBean.seleccionarFacturaHistorial(dataFacProc.id)}"
                                                       process="@this" update="frmDatosFac">
                                            <i class="fa fa-eye text-primary"/>
                                        </p:commandLink>
                                    </p:column>

                                </p:dataTable>
                                <p:commandButton value="Exportar">
                                    <p:dataExporter fileName="histFacturaCXP" target="histFacturaCXP" type="xlsx" />
                                </p:commandButton>
                            </p:tab>
                            <p:tab id="tabFacHist" title="#{msgs['sia.factura.historial']}" >
                                <div class="table table-responsive">
                                    <div class="form-inline">
                                        <div class="col-2">
                                            <p:datePicker value="#{proveedorBean.inicio}"
                                                          pattern="dd/MM/yyyy"/>
                                        </div>
                                        <div class="col-2">
                                            <p:datePicker value="#{proveedorBean.fin}"
                                                          pattern="dd/MM/yyyy"/>
                                        </div>
                                        <div class="col-2">                                            
                                            <p:inputText id="folioHIST" class="form-control" value="#{proveedorBean.folioHist}"
                                                         placeholder="Folio Factura"/>
                                        </div>
                                        <div class="col-2">
                                            <p:commandLink value="#{msgs['sia.factura.buscar']}" action="#{proveedorBean.buscarHistorial()}" 
                                                           styleClass="btn btn-primary text-white" 
                                                           process="@this frmPrincipal:tbPrincipal:tabFacHist" 
                                                           update="frmPrincipal:tbPrincipal:histFactura"/>
                                        </div>
                                    </div>
                                    <div class="table table-responsive">
                                        <p:dataTable id="histFactura" value="#{proveedorBean.mapaInicial.get('facturaPorProveedor')}" var="dataFacProc"
                                                     paginator="true" rows="20" paginatorPosition="bottom"  size="small" showGridlines="true">
                                            <p:column headerText="#{msgs['sia.orden']}">
                                                <h:outputText value="#{dataFacProc.codigoOrden}"/>
                                            </p:column>
                                            <p:column headerText="#{msgs['sia.orden.pedido']}">
                                                <h:outputText value="#{dataFacProc.pedidoNav}"/>
                                            </p:column>
                                            <p:column headerText="#{msgs['sia.bloque.nombre']}">
                                                <h:outputText value="#{dataFacProc.campo}"/>
                                            </p:column>
                                            <p:column headerText="#{msgs['sia.nombre.referencia']}">
                                                <h:outputText value="#{dataFacProc.concepto}"/>
                                            </p:column>
                                            <p:column headerText="#{msgs['sia.factura.folio']}">
                                                <h:outputText value="#{dataFacProc.folio}"/>
                                            </p:column>
                                            <p:column headerText="#{msgs['sia.factura.fecha.emision']}">
                                                <h:outputText value="#{dataFacProc.fechaEmision}"/>
                                            </p:column>
                                            <p:column headerText="#{msgs['sia.orden.total']}">
                                                <h:outputText value="#{dataFacProc.monto}">
                                                    <f:convertNumber maxFractionDigits="2"/>
                                                </h:outputText>
                                            </p:column>
                                            <p:column headerText="#{msgs['sia.orden.moneda']}">
                                                <h:outputText value="#{dataFacProc.moneda}"/>
                                            </p:column>
                                            <p:column width="5%" >
                                                <p:commandLink action="#{proveedorBean.seleccionarFacturaHistorial(dataFacProc.id)}"
                                                               process="@this" update="frmDatosFac">
                                                    <i class="fa fa-eye text-primary"/>
                                                </p:commandLink>
                                            </p:column>
                                        </p:dataTable>
                                        <p:commandButton value="Exportar">
                                            <p:dataExporter fileName="histFactura" target="histFactura" type="xlsx"/>
                                        </p:commandButton>
                                    </div>
                                </div>
                            </p:tab>
                        </p:tabView>
                    </h:form>
                </div>

                <script type="text/javascript">
//                    function startIntro() {
//                        var intro = introJs();
//                        intro.setOptions({
//                            steps: [
//                                {
//                                    element: document.querySelector('#tabOrdenesLbl'),
//                                    intro: "Esta pestaña le muestra las órdenes que tiene asignadas, por compañía.",
//                                },
//                                {
//                                    element: document.querySelector('#tabEnviadasLbl'),
//                                    intro: "Esta pestaña le muestra las facturas que ya le ha enviado al cliente.",
//                                },
//                                {
//                                    element: document.querySelector('#tabDevueltasLbl'),
//                                    intro: "Esta pestaña le muestra las facturas que el cliente le ha devuelto.",
//                                },
//                                {
//                                    element: document.querySelector('#frmOcs\\:companias'),
//                                    intro: "Puede filtrar las órdenes por compañía, si es que no le aparece listada la orden que desea procesar.",
//                                },
//                                {
//                                    element: document.querySelector('#frmOcs\\:campos'),
//                                    intro: "Puede filtrar por un campo en particular de la compañía seleccionada.",
//                                },
//                                {
//                                    element: document.querySelector('#frmOcs\\:codOcs'),
//                                    intro: "También puede buscar una orden utilizando el campo de número de orden.",
//                                },
//                                {
//                                    element: document.querySelector('#frmOcs\\:buscarOrden'),
//                                    intro: "Para ejecutar la búsqueda de la orden, pulse este botón."
//                                },
//                                {
//                                    element: document.querySelector('tablaOrdenes'),
//                                    intro: "Para cargar los documentos de la orden, pulse el engrane azul localizado en la última columna del renglón de la orden."
//                                }
//                            ]
//                        });
//
//                        intro.start();
//                    }
                </script>

                <ui:fragment rendered="#{!sesion.proveedorVo.archivosCargados}">
                    <script type="text/javascript">
                        $(document).ready(function () {
                            $(dialogoMensajeArchivo).modal('show');
                        });
                    </script>

                </ui:fragment>

            </ui:define>
        </ui:composition>
    </body>
</html>