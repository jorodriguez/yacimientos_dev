<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
                xmlns:h="http://xmlns.jcp.org/jsf/html">    
    <!-- Modal Panel para mostrar el detalle de la factura-->
    <div class="modal fade" id="dialogoDatosFacturaHistorial" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-lg" >
            <h:form id="frmFactID">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Datos de la factura</h4>
                    </div>
                    <div class="modal-body card-body">
                        <div class="form-group col-12">                            
                            <p:tabView  style="font-size: 0.9em;">
                                <p:tab title="Datos generales" >
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-group">
                                                <h:outputLabel value="Folio" class="control-label col-12"/>
                                                <div class="col-10">
                                                    <h:outputText value="#{historialFacturaBean.facturaVo.folio}"/>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <h:outputLabel value="Concepto" class="control-label col-12"/>
                                                <div class="col-10">
                                                    <h:outputText value="#{historialFacturaBean.facturaVo.concepto}"/>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <h:outputLabel value="Monto" class="control-label col-12"/>
                                                <div class="col-10">
                                                    <h:outputText value="#{historialFacturaBean.facturaVo.monto}">
                                                        <f:convertNumber groupingUsed="true" maxFractionDigits="4" type="currency"
                                                                         pattern="#,###.0000"/>
                                                    </h:outputText>
                                                    #{historialFacturaBean.facturaVo.moneda}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-group">
                                                <h:outputLabel value="Proveedor" class="control-label col-12"/>
                                                <div class="col-12">
                                                    <h:outputText value="#{historialFacturaBean.facturaVo.proveedor}"/>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <h:outputLabel value="Emisión" class="control-label col-10"/>
                                                <div class="col-12">
                                                    <h:outputText value="#{historialFacturaBean.facturaVo.fechaEmision}">
                                                        <f:convertDateTime pattern="dd/MM/yyyy"/>
                                                    </h:outputText>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <h:outputLabel value="Carta CN" class="control-label col-12"/>
                                                <div class="col-12">
                                                    <h:outputLabel value="No CN" style="font-style: italic;" 
                                                                   rendered="#{historialFacturaBean.facturaVo.idAdjunto eq 0}"/>
                                                    <h:outputLink   
                                                                    rendered="#{historialFacturaBean.facturaVo.uuId ne null}"
                                                                    target="_blank"  
                                                                    id="abrirReq"
                                                                    title="Click aqui para abrir el archivo..." 
                                                                    value="/Compras/AbrirArchivo?ZWZ2W=#{historialFacturaBean.facturaVo.idAdjunto}&amp;ZWZ3W=#{historialFacturaBean.facturaVo.uuId}">
                                                        <h:outputText value=" Abrir"/>
                                                    </h:outputLink>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <h:outputLabel value="Pedido" class="control-label col-12"/>
                                                <div class="col-12">                                                    
                                                    <h:outputLink   
                                                                    rendered="#{historialFacturaBean.facturaVo.urlPdfCompra ne null}"
                                                                    target="_blank"                                                                      
                                                                    title="Click aqui para abrir el pedido #{historialFacturaBean.facturaVo.pedidoNav}" 
                                                                    value="#{historialFacturaBean.facturaVo.urlPdfCompra}">
                                                        <h:outputText value="#{historialFacturaBean.facturaVo.pedidoNav}"/>
                                                    </h:outputLink>
                                                </div>
                                            </div>



                                        </div>
                                    </div>
                                </p:tab>
                                <p:tab title="Partidas">
                                    <p:dataTable size="small" stripedRows="true" showGridlines="true" value="#{historialFacturaBean.facturaVo.detalleFactura}" var="dataDetFac"
                                                   >
                                        <f:facet name="header">Partidas facturadas</f:facet>
                                        <p:column headerText="Descripción" style="text-align: justify">
                                            #{dataDetFac.descripcion}
                                        </p:column>
                                        <p:column headerText="Cantidad">
                                            #{dataDetFac.cantidad}
                                        </p:column>
                                        <p:column headerText="Precio">
                                            <h:outputText value="#{dataDetFac.precio}">
                                                <f:convertNumber groupingUsed="true" maxFractionDigits="4" type="currency"
                                                                 pattern="#,###.0000"/>
                                            </h:outputText>
                                        </p:column>
                                        <p:column headerText="Importe">
                                            <h:outputText value="#{dataDetFac.importe}" style="#{empty dataDetFac.descripcion ? 'font-size: 1.2em; font-weight: bold;' :''}">
                                                <f:convertNumber groupingUsed="true" maxFractionDigits="4" type="currency"
                                                                 pattern="#,###.0000"/>
                                            </h:outputText>
                                        </p:column>
                                    </p:dataTable>
                                </p:tab>                                
                                <p:tab title="Evidencias / Soportes">
                                    <p:dataTable size="small" stripedRows="true" showGridlines="true" value="#{historialFacturaBean.listaArchivosFactura}" var="dataFac">
                                        <p:column headerText="Tipo">
                                            #{dataFac.tipo}
                                        </p:column>
                                        <p:column headerText="Nombre">
                                            #{dataFac.adjuntoVo.nombre}
                                        </p:column>
                                        <p:column >
                                            <h:outputLink   
                                                            target="_blank"  
                                                            id="abrirReq"
                                                            title="Click aqui para abrir el archivo..." 
                                                            value="/Compras/AbrirArchivo?ZWZ2W=#{dataFac.adjuntoVo.id}&amp;ZWZ3W=#{dataFac.adjuntoVo.uuid}">
                                                <h:outputText value=" Abrir"/>
                                            </h:outputLink>
                                        </p:column>
                                    </p:dataTable>
                                </p:tab>
                                <p:tab title="Contenido Nacional">
                                    <p:dataTable size="small" stripedRows="true" showGridlines="true" value="#{historialFacturaBean.contenidoNacional}" var="dataCN">
                                        <p:column headerText="Código">
                                            #{dataCN.codigoCatalogoHidro}
                                        </p:column>
                                        <p:column headerText="Descripción de bienes y/o servicios" >
                                            <p style="#{dataCN.id gt 0 ? 'text-align: left;' : 'text-align: right; font-weight: bold;'}"> 
                                                <h:outputText value="#{dataCN.nombreCatalogoHidro}" />
                                            </p>
                                        </p:column>
                                        <p:column headerText="Cont. Nac.">                                            
                                            #{dataCN.proporcionContenido}
                                        </p:column>
                                        <p:column headerText="Monto Facturado Acumulado por año"  style="text-align: right;">
                                            <h:outputText value="#{dataCN.montoFacturado}" >
                                                <f:convertNumber groupingUsed="true" maxFractionDigits="4" type="currency"
                                                                 pattern="#,###.0000"/>
                                            </h:outputText>
                                            <b>
                                                <h:outputText rendered="#{dataCN.id eq 0}" value="#{dataCN.totalMontoFacturado}" style="text-align: right;">
                                                    <f:convertNumber groupingUsed="true" maxFractionDigits="4" type="currency"
                                                                     pattern="#,###.0000"/>
                                                </h:outputText>
                                            </b>
                                        </p:column>
                                    </p:dataTable>
                                </p:tab>
                                <p:tab title="Nota(s) de crédito (#{historialFacturaBean.listaNotaCredito.size()})">
                                    <p:dataTable size="small" stripedRows="true" showGridlines="true" value="#{historialFacturaBean.listaNotaCredito}" var="dataNota">
                                        <p:column headerText="Folio"
                                                    style="#{historialFacturaBean.facturaVo.idStatus eq 731 ? (dataNota.aceptaAvanzia ? 'background-color: green' : 'background-color: yellow') : ''};">
                                            #{dataNota.folio}
                                        </p:column>
                                        <p:column headerText="Concepto"
                                                    style="#{historialFacturaBean.facturaVo.idStatus eq 731 ? (dataNota.aceptaAvanzia ? 'background-color: green' : 'background-color: yellow') : ''};">
                                            #{dataNota.concepto}
                                        </p:column>
                                        <p:column headerText="Monto CN"
                                                    style="#{historialFacturaBean.facturaVo.idStatus eq 731 ? (dataNota.aceptaAvanzia ? 'background-color: green' : 'background-color: yellow') : ''};">
                                            <h:outputText value="#{dataNota.monto}">
                                                <f:convertNumber groupingUsed="true" maxFractionDigits="4" type="currency"
                                                                 pattern="#,###.0000"/>
                                            </h:outputText>
                                        </p:column>
                                        <p:column
                                            style="#{historialFacturaBean.facturaVo.idStatus eq 731 ? (dataNota.aceptaAvanzia ? 'background-color: green' : 'background-color: yellow') : ''};">
                                            <p:commandLink action="#{historialFacturaBean.seleccionarNotaCredito(dataNota.id)}"
                                                           process="@this" update="frmNotaCredito">
                                                <i class="fa fa-cog text-primary"/>
                                            </p:commandLink>
                                        </p:column>
                                    </p:dataTable>
                                </p:tab>                                
                                <p:tab rendered="#{historialFacturaBean.rechazarFactura}" >                                    
                                    <div class="row">
                                        <div class="col-12">
                                            <h4 class="modal-title">Rechazar Factura</h4>
                                        </div>
                                        <div class="col-12">
                                            <div class="form-group col-12">
                                                <h:outputText value="Motivo:" class="control-label col-12"/>
                                                <div class="col-10">
                                                    <h:inputTextarea id="motivoInp" value="#{historialFacturaBean.motivo}"                                                                     
                                                                     styleClass="form-control"/>                                                    
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <p:commandLink value="Rechazar" onclick="return validaCancelar('frmFactID', 'motivoInp', 'El proceso rechazará y devolverá la factura al proveedor. ¿Está seguro?', 'Es necesario agregar el motivo');" 
                                                           action="#{historialFacturaBean.devolverFactura}" class="btn btn-info"
                                                           process="@this" update="frmFactID"/>

                                        </div>
                                    </div>
                                </p:tab>
                                <p:tab rendered="#{historialFacturaBean.rechazarFactura}" >                                    
                                    <ui:fragment rendered="#{historialFacturaBean.facturaVo.idStatus lt 131 or (historialFacturaBean.listaNotaCredito.size() eq 0 and !historialFacturaBean.facturaVo.aceptaAvanzia) or (historialFacturaBean.listaNotaCredito.size() gt 0 and (!historialFacturaBean.listaNotaCredito.get(0).aceptaAvanzia or !historialFacturaBean.facturaVo.aceptaAvanzia))}">
                                        <div class="row">
                                            <div class="col-12">
                                                <h4 class="modal-title">Enviar Factura</h4>
                                            </div>                                              
                                            <div class="col-12" style="margin-top: 5px; margin-bottom: 10px;">
                                                <div class="col-6">
                                                    <p:commandLink value="Enviar Factura" 
                                                                   action="#{historialFacturaBean.aceptarFacturaAvanzia}" 
                                                                   class="btn btn-info" process="@this" update="frmFactID"/>
                                                </div>                                            
                                                <div class="col-6">
                                                    <h:outputLabel rendered="#{historialFacturaBean.facturaVo.idStatus eq 731}" value="Ya fueron enviados los archivos XML y PDF de la factura a Navision." class="control-label col-12"/>
                                                    <h:outputLabel style="background-color: yellow;" rendered="#{historialFacturaBean.facturaVo.idStatus eq 731 and historialFacturaBean.listaNotaCredito.size() gt 0 and !historialFacturaBean.facturaVo.aceptaAvanziaNc}" value="Los archivos XML y PDF de la nota de credito no han sido aceptados." class="control-label col-12"/>
                                                </div>
                                            </div>
                                        </div>
                                    </ui:fragment>                                    
                                    <ui:fragment rendered="#{historialFacturaBean.facturaVo.idStatus eq 731 and historialFacturaBean.facturaVo.aceptaAvanzia and historialFacturaBean.facturaVo.aceptaAvanziaNc}">
                                        <div class="row">
                                            <div class="col-12">
                                                <h4 class="modal-title">Aceptar Factura</h4>
                                            </div>                                              
                                            <div class="col-12" >
                                                <div class="col-6">
                                                    <p:commandLink value="Aceptar" 
                                                                   action="#{historialFacturaBean.aceptarFactura}" class="btn btn-info"
                                                                   process="@this" update="frmFactID" />
                                                </div>
                                                <div class="col-6">

                                                </div>
                                            </div>
                                        </div>
                                    </ui:fragment>
                                </p:tab>
                                <p:tab title="REPSE" rendered="#{historialFacturaBean.facturaVo.repses.size() gt 0}">
                                    <p:dataTable size="small" stripedRows="true" showGridlines="true" value="#{historialFacturaBean.facturaVo.repses}" var="dataRepse">
                                        <p:column headerText="Tipo">
                                            #{dataRepse.categoria}
                                        </p:column>
                                        <p:column headerText="Nombre">
                                            #{dataRepse.nombre}
                                        </p:column>
                                        <p:column >
                                            <h:outputLink   
                                                            target="_blank"  
                                                            id="abrirReq"
                                                            title="Click aqui para abrir el archivo..." 
                                                            value="/Compras/AbrirArchivo?ZWZ2W=#{dataRepse.id}&amp;ZWZ3W=#{dataRepse.uuid}">
                                                <h:outputText value=" Abrir"/>
                                            </h:outputLink>
                                        </p:column>
                                    </p:dataTable>
                                </p:tab>
                            </p:tabView>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <p:commandLink value="Cerrar" class="btn btn-default"  onclick="$(dialogoDatosFacturaHistorial).modal('hide');"/>
                    </div>
                </div>
            </h:form>
        </div>
    </div>
    <!-- Modal Panel para mostrar el detalle de la factura-->
    <div class="modal fade" id="dialogoArchivosNotaCredito" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog">
            <h:form  id="frmNotaCredito">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Archivos Nota de Crédito</h4>
                    </div>
                    <div class="modal-body">
                        <p:dataTable size="small" stripedRows="true" showGridlines="true" value="#{historialFacturaBean.listaArchivosNotaCredito}" var="dataNota"
                                       >
                            <p:column headerText="Tipo">
                                #{dataNota.tipo}
                            </p:column>
                            <p:column headerText="Nombre">
                                #{dataNota.adjuntoVo.nombre}
                            </p:column>
                            <p:column >
                                <h:outputLink   
                                                target="_blank"  
                                                id="abrirReq"
                                                title="Click aqui para abrir el archivo..." 
                                                value="/Compras/AbrirArchivo?ZWZ2W=#{dataNota.adjuntoVo.id}&amp;ZWZ3W=#{dataNota.adjuntoVo.uuid}">
                                    <h:outputText value=" Abrir"/>
                                </h:outputLink>
                            </p:column>
                        </p:dataTable>
                    </div>
                    <div class="modal-footer">
                        <p:commandLink value="Cerrar" class="btn btn-default"  onclick="$(dialogoArchivosNotaCredito).modal('hide');"/>
                    </div>
                </div>
            </h:form>
        </div>
    </div>
</ui:composition>