<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

    <body>

        <ui:composition template="../../../../WEB-INF/template/template.xhtml">
            <ui:define name="tituloPagina">
                <h2 class="page-header"> 
                    Contratos en proceso de finiquito</h2>
            </ui:define>
            <ui:define name="contenido">
                <style>
                    .card-height {
                        height: 120px;
                    }
                </style>
                <h:form id="frmMonitor"> 
                    <div class="col-6">
                        <p:selectOneMenu value="#{monitorFiniquitoBean.statusId}"
                                         styleClass="form-control">
                            <f:selectItem itemLabel="En proceso de finiquito" itemValue="360"/>
                            <f:selectItem itemLabel="Proceso de Finiquito terminado" itemValue="370"/>
                            <p:ajax listener="#{monitorFiniquitoBean.cambiarStatusContrato}" update="dtContratos"/>
                        </p:selectOneMenu>
                    </div>
                    <div class="col-12">
                        <p:dataTable id="dtContratos" value="#{monitorFiniquitoBean.contratos}" 
                                     var="dataC" style="font-size: 1.1em;" showGridlines="true" size="small"
                                     rowIndexVar="index">
                            <p:column headerText="Número" style="text-align: left; width: 15%;">
                                <h:outputText value="#{dataC.numero}"/>
                            </p:column>
                            <p:column headerText="Contrato" style="text-align: left;">
                                <h:outputText value="#{dataC.nombre}"/>
                            </p:column>
                            <p:column headerText="Proveedor" style="text-align: left;">
                                <h:outputText value="#{dataC.nombreProveedor}"/>
                            </p:column>
                            <p:column headerText="Inicio" width="80">
                                <h:outputText value="#{dataC.fechaInicio}">
                                    <f:convertDateTime pattern="dd/MM/yyyy"/>
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Fin" width="80">
                                <h:outputText value="#{dataC.fechaVencimiento}">
                                    <f:convertDateTime pattern="dd/MM/yyyy"/>
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Total formas" width="80">
                                <h:outputText value="#{dataC.totalFormas}"/>
                            </p:column>
                            <p:column width="35">
                                <p:commandLink onclick="$(dialogoMonitorContratos).modal('show');" 
                                               action="#{monitorFiniquitoBean.mostrarMonitorContrato(index)}"
                                               process="@this" update="frmMonCon">
                                    <i class="fa fa-eye text-primary fa-2x"/>
                                </p:commandLink>
                            </p:column>
                            <p:column width="35">
                                <p:commandLink title="Generar el contrato de finiquito"
                                               action="#{monitorFiniquitoBean.inicioAgregarContratoFiniquito(index)}"
                                               process="@this" update="frmContFin">
                                    <i class="fa fa-cog text-primary fa-2x"/>
                                </p:commandLink>
                            </p:column>
                        </p:dataTable>
                        <p:commandButton value="Exportar">
                            <p:dataExporter fileName="contratosProceso" target="dtContratos" type="xls">
                            </p:dataExporter>
                        </p:commandButton>
                    </div>
                </h:form>
                <!--Datos del proceso de finiquito de contratos-->
                <div class="modal fade" id="dialogoMonitorContratos" data-backdrop="static" data-keyboard="false">
                    <div class="modal-dialog modal-lg modal-xl" >
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title">Proceso de finiquito de contratos</h4>
                            </div>
                            <h:form id="frmMonCon">
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-group">
                                                <h:outputText value="Nombre del contratista:" styleClass="control-label"/>
                                                <div>
                                                    <h:outputLabel value="#{monitorFiniquitoBean.contratoVo.nombreProveedor}"/>
                                                </div>
                                            </div>
                                            <div class="form-group"> 
                                                <h:outputText value="Fecha de vencimiento:" styleClass="control-label"/>
                                                <div >
                                                    <h:outputLabel value="#{monitorFiniquitoBean.contratoVo.fechaVencimiento}"/>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-group">
                                                <h:outputText value="Número:" styleClass="control-label"/>
                                                <div >
                                                    <h:outputLabel value="#{monitorFiniquitoBean.contratoVo.numero}"/>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <h:outputText value="Contrato:" />
                                                <div >
                                                    <h:outputLabel value="#{monitorFiniquitoBean.contratoVo.nombre}" styleClass="control-label"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="card card-default">
                                            <div class="card-header">
                                                <b>Exhortos </b>
                                            </div>
                                            <div class="card-body">
                                                <p:dataTable value="#{monitorFiniquitoBean.exhortosPorContrato}" var="dataEx"
                                                             size="small" showGridlines="true">
                                                    <p:column headerText="Exhorto">
                                                        <h:outputText value="#{dataEx.codigo}"/>
                                                    </p:column>
                                                    <p:column headerText="Recordatorio">
                                                        <h:outputText value="#{dataEx.numero}"/>
                                                    </p:column>
                                                    <p:column headerText="Fecha emisión">
                                                        <h:outputText value="#{dataEx.fechaExhorto}">
                                                            <f:convertDateTime pattern="dd/MM/yyyy"/>
                                                        </h:outputText>
                                                    </p:column>
                                                    <p:column headerText="Plazo en días transcurrido"  style="width: 20%;">
                                                        <h:outputText value="#{dataEx.diasTranscurridos}"/>
                                                    </p:column>
                                                </p:dataTable>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <ui:repeat value="#{monitorFiniquitoBean.contratoFormas}" var="forma"
                                                   varStatus="formaVar">
                                            <div class="col-md-3">
                                                <div class="card #{forma.validado eq true ? 'card-primary' : 'card-default'} ">
                                                    <div class="card-header">
                                                        <div class="row" style="height: 45px;">
                                                            <div class="col-10">
                                                                <h:outputLabel value="#{forma.forma}"/>                                                                            
                                                            </div> 
                                                            <div class="col-2">
                                                                <h:outputLink target="_blank"  title="Descargar el archivo validado" 
                                                                              value="/Sia/AbrirArchivo?ZWZ2W=#{forma.idAdjunto}&amp;ZWZ3W=#{forma.uuIdAdjunto}"
                                                                              rendered="#{forma.idAdjunto gt 0 and forma.validado eq true}"
                                                                              style="color: white;">
                                                                    <i class="fa fa-file fa-2x" />
                                                                </h:outputLink>

                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card-body">
                                                        <div>                                                                        
                                                            <h:outputLabel value="#{forma.proveedor}" 
                                                                           rendered="#{empty forma.gerencia}"/>
                                                            <div>
                                                                <div>
                                                                    <h:outputLabel value="#{empty forma.gerencia ? 'Proveedor' : forma.gerencia}"/>
                                                                </div>
                                                                <h:outputLabel value="#{not empty forma.gerencia ? forma.responsableGerencia : ''}"/>
                                                            </div>
                                                        </div>
                                                        <div class="form-group">  
                                                            <p:dataTable value="#{forma.notificaciones}" 
                                                                         var="dtNot" paginatorAlwaysVisible="false"
                                                                         rows="2" paginatorPosition="top" 
                                                                         showGridlines="true" size="small">
                                                                <p:column headerText="Notificó a" style="text-align: left;">
                                                                    <h:outputText value="#{dtNot.notificoA}" 
                                                                                  style="overflow-y:scroll;" 
                                                                                  title="#{dtNot.notificoATodos}"/>
                                                                </p:column>
                                                                <p:column headerText="Fecha">
                                                                    <h:outputText value="#{dtNot.fechaGenero}">
                                                                        <f:convertDateTime pattern="dd/MM/yyyy"/>
                                                                    </h:outputText>
                                                                </p:column>
                                                                <p:column headerText="Fecha">
                                                                    <h:outputText value="#{dtNot.horaGenero}">
                                                                        <f:convertDateTime pattern="HH:mm a"/>
                                                                    </h:outputText>
                                                                </p:column>
                                                            </p:dataTable>
                                                        </div>
                                                        <p:dataTable value="" size="small" showGridlines="true" >
                                                            <p:column style="width: 80%; text-align:  left;" >
                                                                <f:facet name="header">Validó</f:facet>
                                                                <h:outputText value="#{forma.usuarioValido}" 
                                                                              class="control-label" rendered="#{not empty forma.gerencia}"/>
                                                                <h:outputText value="#{forma.proveedor}" 
                                                                              class="control-label" rendered="#{empty forma.gerencia and forma.validado eq true}"/>
                                                            </p:column>
                                                            <p:column width="20%" >
                                                                <f:facet name="header">Fecha</f:facet>
                                                                <h:outputText value="#{forma.fechaValido}" 
                                                                              rendered="#{forma.validado eq true}"
                                                                              style="text-align: left;">
                                                                    <f:convertDateTime pattern="dd/MM/yyyy"/>
                                                                </h:outputText>
                                                            </p:column>
                                                        </p:dataTable>
                                                    </div>
                                                    <div class="card-footer">
                                                        <h:outputText value="Status: "/>
                                                        <h:outputLabel value="#{forma.validado eq false ? 'Sin Validar' :'Validado'}" rendered="#{forma.idAdjunto gt 0}"/>
                                                        <h:outputLabel value="No hay archivo" rendered="#{forma.idAdjunto eq 0}"/>
                                                    </div>
                                                </div>
                                            </div>                                        
                                        </ui:repeat>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <p:commandLink value="Cerrar" onclick="$(dialogoMonitorContratos).modal('hide');" immediate="true"/>
                                </div>
                            </h:form>
                        </div>
                    </div>
                </div>
                <!--  -->
                <div class="modal fade" id="dialogoContratoNuevo" data-backdrop="static" data-keyboard="false">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title">Registro d contrato de finiquito</h4>
                            </div>
                            <h:form id="frmContFin">
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="form-group">
                                            <div class="col-4">
                                                <div class="form-group">
                                                    <h:outputText value="Número:"/>
                                                    <div>
                                                        <h:outputLabel value="#{monitorFiniquitoBean.contratoVo.numero}"/>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-8">
                                                <div class="form-group">
                                                    <h:outputText value="Contrato:"/>
                                                    <div>
                                                        <h:outputLabel value="#{monitorFiniquitoBean.contratoVo.nombre}"/>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>                                        
                                    </div>
                                    <div class="form-group">
                                        <h:outputText value="Objetivo:"/>
                                        <div >
                                            <h:inputTextarea value="#{monitorFiniquitoBean.contratoFiniquitoVo.nombre}" 
                                                             rows="5" styleClass="form-control" required="true" 
                                                             requiredMessage="Es necesario agregar el objetivo."/>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <p:commandLink value="Cerrar" onclick="$(dialogoContratoNuevo).modal('hide');"
                                                   styleClass="btn btn-default" immediate="true"/>
                                    <p:commandButton value="Guardar" action="#{monitorFiniquitoBean.guardarContratoFiniquito}"
                                                   styleClass="btn btn-primary" process="@form" update="frmMonitor"/>
                                </div>
                            </h:form>
                        </div>
                    </div>
                </div>
            </ui:define>
        </ui:composition>
    </body>
</html>
